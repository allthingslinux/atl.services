// Shared Alloy Configuration for Remote Agents
// Collects: Node Exporter, cAdvisor, Docker Logs
// Forwards to: Central Mimir and Loki

// ============================================
// Logging: Collect Docker logs
// ============================================
loki.source.docker "containers" {
  host       = "unix:///var/run/docker.sock"
  targets    = []
  forward_to = [loki.process.add_labels.receiver]
  
  relabel_rules {
    source_labels = ["__meta_docker_container_name"]
    target_label  = "container"
  }
}

loki.process "add_labels" {
  forward_to = [loki.write.default.receiver]

  // Add static labels for the host
  stage.static_labels {
      values = {
        instance = sys.env("HOSTNAME"),
        job      = "docker-logs",
      }
  }
}

loki.write "default" {
  endpoint {
    url = sys.env("LOKI_URL")
    // Basic Auth if needed
    // basic_auth {
    //   username = sys.env("BASIC_AUTH_USER")
    //   password = sys.env("BASIC_AUTH_PASS")
    // }
  }
}

// ============================================
// Metrics: Scrape Local Exporters
// ============================================

prometheus.scrape "node_exporter" {
  targets = [{"__address__" = "node-exporter:9100"}]
  job_name = "node-exporter"
  
  // Add instance label
  relabel_rules {
    target_label = "instance"
    replacement  = sys.env("HOSTNAME")
  }
  
  forward_to = [prometheus.remote_write.default.receiver]
}

prometheus.scrape "cadvisor" {
  targets = [{"__address__" = "cadvisor:8080"}]
  job_name = "cadvisor"

  // Add instance label
  relabel_rules {
    target_label = "instance"
    replacement  = sys.env("HOSTNAME")
  }

  forward_to = [prometheus.remote_write.default.receiver]
}

// ============================================
// Forwarding: Send to Central Mimir
// ============================================

prometheus.remote_write "default" {
  endpoint {
    url = sys.env("REMOTE_WRITE_URL")
    // Basic Auth if needed
    // basic_auth {
    //   username = sys.env("BASIC_AUTH_USER")
    //   password = sys.env("BASIC_AUTH_PASS")
    // }
  }
}
