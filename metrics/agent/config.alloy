// ============================================
// GRAFANA ALLOY - REMOTE MONITORING AGENT
// ============================================
// This configuration is deployed to remote VPS nodes to collect host metrics,
// container metrics, and Docker logs, then forward them to the central stack.
//
// Deployment Locations:
//   - atl.network (NPM, Coturn, Blocky, Gatus, SFTPGo, etc.)
//   - atl.chat (IRC, XMPP, Bridge, PostgreSQL)
//   - atl.wiki (MediaWiki, MariaDB, Valkey, MinIO)
//   - dev-tux (Discord bot, PostgreSQL, Valkey)
//   - iso.atl.dev (Keycloak, PostgreSQL)
//
// Pipeline Architecture:
//   Logs:    loki.source.docker → loki.process → loki.write → Central Loki
//   Metrics: prometheus.scrape → prometheus.remote_write → Central Mimir
//
// Required Environment Variables:
//   HOSTNAME           - Unique identifier for this host (e.g., "atl-chat")
//   LOKI_URL           - Central Loki endpoint (e.g., "http://100.x.x.x:3100/loki/api/v1/push")
//   REMOTE_WRITE_URL   - Central Mimir endpoint (e.g., "http://100.x.x.x:8080/api/v1/push")
//   BASIC_AUTH_USER    - (Optional) Basic auth username if central stack requires it
//   BASIC_AUTH_PASS    - (Optional) Basic auth password if central stack requires it
//
// Reference: https://grafana.com/docs/alloy/latest/collect/
// ============================================

// Note: sys.env() is a standard library function for accessing environment variables
// Reference: https://grafana.com/docs/alloy/latest/reference/stdlib/sys/

// ============================================
// LIVE DEBUGGING
// ============================================
// Enable live debugging to stream real-time component data to the Alloy UI
// Access the UI at http://localhost:12345 to monitor pipeline health
// Reference: https://grafana.com/docs/alloy/latest/troubleshoot/debug/#live-debugging-page
livedebugging {
  enabled = true
}

// ============================================
// LOGGING PIPELINE
// ============================================
// Collect logs from all Docker containers on this host
// Component: loki.source.docker
// Reference: https://grafana.com/docs/alloy/latest/reference/components/loki/loki.source.docker/
loki.source.docker "containers" {
  host       = "unix:///var/run/docker.sock"
  targets    = []  // Empty = collect from all containers
  forward_to = [loki.process.add_labels.receiver]
  
  relabel_rules {
    source_labels = ["__meta_docker_container_name"]
    target_label  = "container"
  }
}

// Add host-specific labels to all log entries
// This ensures logs from different hosts can be distinguished in Loki
// Component: loki.process
// Reference: https://grafana.com/docs/alloy/latest/reference/components/loki/loki.process/
loki.process "add_labels" {
  forward_to = [loki.write.default.receiver]

  // Add static labels identifying this host
  stage.static_labels {
      values = {
        instance = sys.env("HOSTNAME"),  // e.g., "atl-chat", "atl-network"
        job      = "docker-logs",
      }
  }
}

// Forward logs to central Loki instance
// Component: loki.write
// Reference: https://grafana.com/docs/alloy/latest/reference/components/loki/loki.write/
loki.write "default" {
  endpoint {
    url = sys.env("LOKI_URL")  // e.g., "http://100.64.2.0:3100/loki/api/v1/push"
    
    // Uncomment if central stack requires basic authentication
    // basic_auth {
    //   username = sys.env("BASIC_AUTH_USER")
    //   password = sys.env("BASIC_AUTH_PASS")
    // }
  }
}

// ============================================
// METRICS PIPELINE
// ============================================

// Built-in Node Exporter (Unix)
// Component: prometheus.exporter.unix
// Reference: https://grafana.com/docs/alloy/latest/reference/components/prometheus/prometheus.exporter.unix/
prometheus.exporter.unix "host" {
  rootfs_path = "/rootfs"
  sysfs_path  = "/sys"
  procfs_path = "/rootfs/proc" // Access procfs through rootfs mount
}

prometheus.scrape "node_exporter" {
  targets    = prometheus.exporter.unix.host.targets
  job_name   = "node-exporter"
  
  // Override instance label with hostname for multi-host identification
  relabel_rules {
    target_label = "instance"
    replacement  = sys.env("HOSTNAME")  // e.g., "atl-chat"
  }
  
  forward_to = [prometheus.remote_write.default.receiver]
}

// Scrape cAdvisor for container-level metrics (CPU throttling, memory, OOM kills)
// Component: prometheus.scrape
// Reference: https://grafana.com/docs/alloy/latest/collect/prometheus-metrics/
// Built-in cAdvisor Exporter
// Component: prometheus.exporter.cadvisor
// Reference: https://grafana.com/docs/alloy/latest/reference/components/prometheus/prometheus.exporter.cadvisor/
prometheus.exporter.cadvisor "containers" {
  docker_host = "unix:///var/run/docker.sock"
  docker_only = true
  storage_duration = "5m"
}

prometheus.scrape "cadvisor" {
  targets    = prometheus.exporter.cadvisor.containers.targets
  job_name   = "cadvisor"

  // Override instance label with hostname for multi-host identification
  relabel_rules {
    target_label = "instance"
    replacement  = sys.env("HOSTNAME")  // e.g., "atl-network"
  }

  forward_to = [prometheus.remote_write.default.receiver]
}

// ============================================
// METRICS FORWARDING
// ============================================

// Forward metrics to central Grafana Mimir instance
// Component: prometheus.remote_write
// Reference: https://grafana.com/docs/alloy/latest/reference/components/prometheus/prometheus.remote_write/
prometheus.remote_write "default" {
  endpoint {
    url = sys.env("REMOTE_WRITE_URL")  // e.g., "http://100.64.2.0:8080/api/v1/push"
    
    // Uncomment if central stack requires basic authentication
    // basic_auth {
    //   username = sys.env("BASIC_AUTH_USER")
    //   password = sys.env("BASIC_AUTH_PASS")
    // }
  }
}
